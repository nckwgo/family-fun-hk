<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FF Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold">Family Fun HK · 後台</h1>
      <a href="/index.html" class="text-sm underline">返回前台</a>
    </div>

    <!-- 登入 -->
    <section id="auth" class="bg-white rounded-xl shadow p-4 grid gap-3">
      <div class="text-sm">Email Magic Link 登入</div>
      <input id="email" type="email" placeholder="you@example.com" class="border rounded px-3 py-2 w-80" />
      <button id="send" class="px-4 py-2 bg-black text-white rounded w-fit">發送登入連結</button>
      <p class="text-xs text-gray-500">登入後顯示表單與上傳。</p>
    </section>

    <!-- 表單 -->
    <section id="formWrap" class="hidden bg-white rounded-xl shadow p-4 mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">新增 / 更新活動</h2>
        <button id="logout" class="text-sm underline">登出</button>
      </div>

      <form id="form" class="grid md:grid-cols-2 gap-3 max-w-xl">
        <input id="title" class="border p-2 w-full" placeholder="標題 *" required />
        <input id="date" type="date" class="border p-2 w-full" required />
        <input id="time" class="border p-2 w-full md:col-span-2" placeholder="時間 如 15:00-17:00" />
        <input id="district" class="border p-2 w-full" placeholder="地區（港島/九龍/新界）" />
        <input id="price" class="border p-2 w-full" placeholder="費用（$80 / Free）" />
        <input id="age" class="border p-2 w-full" placeholder="年齡（3-8歲）" />
        <input id="category" class="border p-2 w-full" placeholder="類別（展覽/工作坊/戶外）" />
        <input id="source_url" class="border p-2 w-full md:col-span-2" placeholder="來源連結（可選）" />
        <div class="md:col-span-2">
          <label class="text-sm block mb-1">封面圖片（可選）</label>
          <input id="cover" type="file" accept="image/*" class="border p-2 w-full" />
        </div>
        <button class="md:col-span-2 px-4 py-2 bg-green-600 text-white rounded w-fit">提交</button>
      </form>

      <p id="msg" class="mt-3 text-sm"></p>
    </section>
  </div>

  <script>
    const SUPABASE_URL = "https://edgghhcgjwzhujnvqxso.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZ2doaGNnand6aHVqbnZxeHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMzEzMTIsImV4cCI6MjA3MDYwNzMxMn0.UMx-P9UXZut6CBPiJqAlt-RLaUuDeN_CPjbPKP8Kg4M";
    const BUCKET = "events";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const authBox = $('auth');
    const formWrap = $('formWrap');

    $('send').onclick = async () => {
      const email = $('email').value.trim();
      if (!email) return alert('請輸入電郵');
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: location.href }
      });
      if (error) return alert(error.message);
      alert('已發送登入連結，請到電郵點擊。');
    };

    $('logout').onclick = async () => {
      await sb.auth.signOut();
      location.reload();
    };

    sb.auth.onAuthStateChange((_e, session) => {
      const loggedIn = !!session?.user;
      authBox.classList.toggle('hidden', loggedIn);
      formWrap.classList.toggle('hidden', !loggedIn);
    });

    $('form').onsubmit = async (ev) => {
      ev.preventDefault();
      const u = (await sb.auth.getUser()).data.user;
      if (!u) return alert('未登入');

      // 上傳封面（可選）
      let cover_url = '';
      const file = $('cover').files[0];
      if (file) {
        const path = `${u.id}/${Date.now()}-${file.name}`;
        const up = await sb.storage.from(BUCKET).upload(path, file, { upsert: true });
        if (up.error) { $('msg').textContent = up.error.message; return; }
        cover_url = sb.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
      }

      const payload = {
        title: $('title').value.trim(),
        date: $('date').value,
        time: $('time').value.trim(),
        district: $('district').value.trim(),
        price: $('price').value.trim(),
        age: $('age').value.trim(),
        category: $('category').value.trim(),
        source_url: $('source_url').value.trim(),
        cover_url
      };

      const { error } = await sb.from('events').insert(payload);
      $('msg').textContent = error ? error.message : '已提交';
      if (!error) $('form').reset();
    };
  </script>
</body>
</html>
